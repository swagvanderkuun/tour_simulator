# Tour de France Versus Mode

## Overview

Versus Mode is a new functionality that allows you to select your own team of 20 riders and compare its performance against the optimal team generated by the team optimization algorithm. This feature helps you understand how well your team selection strategy performs and provides detailed analysis of stage-by-stage performance.

## Features

- **Team Selection**: Interactive selection of 20 riders with a budget of 48 points
- **Stage Optimization**: Automatic optimization of which 9 riders to use for each stage (1-21) from your selected team
- **Multiple Simulations**: Run 100 simulations to get reliable performance statistics
- **Optimal Team Comparison**: Compare your team against the mathematically optimal team
- **Detailed Analysis**: Stage-by-stage comparison and comprehensive Excel reports

## How to Use

### Method 1: Direct Access
```bash
python run_versus_mode.py
```

### Method 2: Through Main Simulator
```bash
python simulator.py
# Then select option 2 for Versus Mode
```

### Method 3: Programmatic Access
```python
from versus_mode import VersusMode

# Initialize versus mode
versus = VersusMode()

# Get available riders
riders = versus.get_available_riders()

# Create your team (example)
selected_riders = ["Tadej Pogačar", "Jonas Vingegaard", "Primož Roglič", ...]  # 20 riders total

# Validate team
is_valid, message = versus.validate_team_selection(selected_riders)
if not is_valid:
    print(f"Error: {message}")
    exit()

# Create user team
user_team = versus.create_user_team(selected_riders)

# Run the full versus mode analysis
rider_data = versus.team_optimizer.run_simulation(num_simulations=50)
user_team = versus.optimize_stage_selection(user_team, rider_data, num_simulations=50)
simulation_results = versus.run_user_team_simulations(user_team, num_simulations=100)
optimal_team = versus.get_optimal_team(num_simulations=50)
comparison = versus.compare_teams(user_team, optimal_team)

# Save results
filename = versus.save_versus_results(user_team, optimal_team, comparison, rider_data)
print(f"Results saved to {filename}")
```

## Team Selection Rules

When selecting your team, you must follow these constraints:

1. **Exactly 20 riders**
2. **Total cost ≤ 48 points**
3. **Maximum 4 riders per team** (Scorito rule)
4. **All riders must exist in the database**

## Interactive Team Selection

When you run Versus Mode, you'll see an interactive interface that shows:

- All available riders grouped by team
- Rider statistics (age, price, abilities)
- Current selection status
- Remaining budget
- Team composition

### Commands:
- **Type rider name**: Add/remove rider (partial names work)
- **`list`**: Show current selection
- **`done`**: Finish selection (only works with exactly 20 riders)

## Output Files

The Versus Mode generates a comprehensive Excel file with multiple sheets:

### 1. Team_Comparison
Summary comparison between your team and the optimal team:
- Total cost
- Number of riders
- Expected points
- Performance difference

### 2. Rider_Comparison
Detailed comparison of all riders:
- Rider information (name, team, age, price)
- Expected points
- Whether selected in your team, optimal team, or both

### 3. User_Team_Stages
Stage-by-stage analysis for your team:
- Which riders are selected for each stage
- Expected points per stage for each rider

### 4. Optimal_Team_Stages
Stage-by-stage analysis for the optimal team:
- Which riders are selected for each stage
- Expected points per stage for each rider

### 5. Simulation_Results
Results from 100 simulations with your team:
- Total points for each simulation
- Statistical analysis

### 6. Stage_Comparison
Direct comparison of stage performance:
- Points earned by each team per stage
- Difference between teams per stage

## Understanding the Results

### Performance Metrics
- **Average Points**: Mean performance across 100 simulations
- **Standard Deviation**: Consistency of performance
- **Performance Difference**: How much better/worse your team is vs optimal

### Rider Analysis
- **Common Riders**: Riders selected by both you and the algorithm
- **Your Unique Riders**: Riders you selected that the algorithm didn't
- **Optimal Unique Riders**: Riders the algorithm selected that you didn't

### Stage Analysis
- **Stage Selection**: Which 9 riders are optimally used for each stage
- **Points Distribution**: How points are distributed across stages
- **Performance Patterns**: Which stages favor different rider types

## Tips for Better Team Selection

1. **Balance is Key**: Don't focus too heavily on one rider type
2. **Consider Stage Types**: Different stages favor different abilities
3. **Team Composition**: Having multiple riders from strong teams can provide teammate bonuses
4. **Budget Management**: Don't overspend on expensive riders
5. **Risk vs Reward**: Consider abandon probabilities when selecting riders

## Technical Details

### Optimization Algorithm
The stage selection optimization uses Integer Linear Programming (ILP) to:
- Maximize total expected points across all stages
- Ensure exactly 9 riders are selected for stages 1-21
- Ensure all 20 riders are used for stage 22 (final stage)

### Simulation Process
1. **Performance Analysis**: 50 simulations to determine expected rider performance
2. **Stage Optimization**: ILP optimization for stage selection
3. **Team Simulation**: 100 simulations with your team to get performance statistics
4. **Optimal Team Generation**: Generate optimal team using team optimization algorithm
5. **Comparison**: Comprehensive comparison of results

### Dependencies
- `pandas`: Data manipulation and Excel export
- `numpy`: Numerical computations
- `pulp`: Integer Linear Programming optimization
- `simulator`: Tour simulation engine
- `riders`: Rider database and parameters
- `team_optimization`: Optimal team generation

## Troubleshooting

### Common Issues

1. **"Versus Mode not available"**
   - Ensure `versus_mode.py` is in the same directory
   - Check that all dependencies are installed

2. **"Team selection validation failed"**
   - Verify you have exactly 20 riders
   - Check that total cost ≤ 48
   - Ensure no team has more than 4 riders

3. **"Optimization failed"**
   - This usually indicates a problem with the PuLP solver
   - Try reducing the number of simulations
   - Check that all rider data is valid

### Performance Tips

- **Reduce Simulations**: For faster results, reduce `num_simulations` parameters
- **Use SSD**: Excel file generation is faster on solid-state drives
- **Close Excel**: Ensure Excel files are closed before running to avoid permission errors

## Example Output

```
=== COMPARISON RESULTS ===
Your Team:
  Cost: 47.8
  Average Points: 1245.3 ± 45.2
  Riders: Tadej Pogačar, Jonas Vingegaard, ...

Optimal Team:
  Cost: 47.9
  Expected Points: 1289.7
  Riders: Tadej Pogačar, Jonas Vingegaard, ...

Comparison:
  Cost Difference: -0.1
  Performance Difference: -44.4
  Common Riders: 15
  Your Unique Riders: 5
  Optimal Unique Riders: 5
```

This shows that your team costs slightly less but performs about 44 points worse on average, with 15 riders in common with the optimal team. 